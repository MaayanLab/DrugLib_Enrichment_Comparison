---
title: "Expand Gmts"
author: "Damon Pham"
date: "November 25, 2017"
output: html_document
---

```{r setup, echo=FALSE, fig.height=8, fig.width=8}
knitr::opts_chunk$set(options(warn=-1))

#re-format the expansion library and cut down co-expression sets to only the top-n.
get_top_n_coexpressed = function(expansion_library_fname, output_fname, n=100){
  print(output_fname)
  
  if(file.exists(output_fname)){
  	print('already created.')
  	return(NULL)
  }
  
  #process the file accordingly--different expansion library files are formatted differently. 
  if(expansion_library_fname %in% c('human_correlation.rda', 'mouse_correlation.rda')){
    rows_list = vector('list', length=10)
    for(i in 0:9){
      #load the one-tenth of the file at a time (memory limits), row-wise.
      print(i)
      temp_space = new.env()
      f = load(expansion_library_fname, temp_space)
      expansion_library = get(f, temp_space)
      rm(temp_space)
      
      start = floor(nrow(expansion_library)/10*i) + 1
      if(i==9){
        end=nrow(expansion_library)} else {
          end = floor(nrow(expansion_library)/10*(i + 1))}
      expansion_library = expansion_library[start:end,]
      
      #define a function that returns the top n genes
      ##with the highest coexpression values, for a given row.
      get_top_n = function(row){
        return(names(row)[order(row, decreasing=TRUE)[1:n]])
      }
      
      #get the top n genes for each row.
      rows_list[[i+1]] = t(apply(expansion_library, 1, get_top_n))
    }
    #merge all the results.
    top_n = do.call(rbind, rows_list)
    print(dim(top_n))
    rm(rows_list)
    
    
  } else if(expansion_library_fname %in% c('genename_pairsWprob.txt')) {
    #read the file.
    expansion_library = read.table(expansion_library_fname)
    colnames(expansion_library) = c('gene1', 'gene2', 'p')
    
    #remove rows with p-value == 0.
    expansion_library = subset(expansion_library, p > 0)
    
    #get a list of all genes in this file.
    genes = union(expansion_library$gene1, expansion_library$gene2)
    
    coexpressed = as.list(genes)
    names(coexpressed) = genes
    
    #for each gene...
    for(i in 1:nrow(expansion_library)){
      #get a list of all its coexpressed genes.
      #note: the file is already sorted by ascending p value.
      g1 = as.character(expansion_library[[i,'gene1']])
      g2 = as.character(expansion_library[[i,'gene2']])
      
      coexpressed[[g1]] = append(coexpressed[[g1]], g2)
      coexpressed[[g2]] = append(coexpressed[[g2]], g1)
    }

    for(i in names(coexpressed)){
      if(length(coexpressed[[i]]) > n){
        #only keep the top-n coexpressed.
        coexpressed[[i]]=coexpressed[[i]][1:n]
      }
      #add NA values to fill up each row vector to length n.
      length(coexpressed[[i]]) = n
    }
    #merge to matrix.
    top_n = do.call(rbind, coexpressed)
  }
  
  #save to file and return.
  write.table(top_n, output_fname, sep='\t')
  return(top_n)
  
}

expand_gmt = function(gmt_fname, expansion_fname, output_fname){
  #exit if this has already been completed.
  if(file.exists(output_fname)){
    print(paste0(output_fname, ' already created.'))
    return(NULL)
  }
  
  #read in the gmt and expansion files.
  gmt=read.csv(gmt_fname, sep='\t', colClasses='character', row.names=1)
  expansion = read.csv(expansion_fname, sep='\t', colClasses='character', row.names=1)
  
  #create a matrix with rows as the union of genes between the gmt and expansion files,
  #and columns as the gmt experiments.
  gene_union = union(rownames(gmt), rownames(expansion))
  expanded_gmt = matrix(NA, ncol=ncol(gmt), nrow=length(gene_union))
  colnames(expanded_gmt) = colnames(gmt)
  rownames(expanded_gmt) = gene_union
  
  for(c in colnames(expanded_gmt)){
    #expand the column vector using the expansion file.
    #print(c)
    #get a list of genes in this column vector.
    genes = as.character(rownames(gmt[gmt[c]=='True',]))
    #use these genes to index the expansion file.
    e_genes_with_na = as.character(unlist(expansion[genes,]))
    #remove NA values.
    e_genes = e_genes_with_na[!is.na(e_genes_with_na)]
    #replace the column vector with the union of 
    #the sets of genes returned by the expansion file, as well as
    #the original genes in the column vector.
    #(some genes in the column vector are not in the expansion file.)
    genes_to_add = union(genes, e_genes)
    expanded_gmt[genes_to_add, c] = 'True'
  }
  
  write.table(expanded_gmt, output_fname, na='', sep='\t', quote=FALSE)
}

for(gmt in c('1_DrugBank_EdgeList_10-05-17', '2_TargetCentral_EdgeList_10-05-17', '3_EdgeLists_Union_10-05-17', '4_EdgeLists_Intersection_10-05-17')){
  for(expansion in c('genename_pairsWprob_top_100', 'human_correlation_top_100')){
    if(expansion=='genename_pairsWprob_top_100'){exp_libname='hu.MAP'}
    else{exp_libname='ARCHS4'}
    output_fname = paste0('libs\\', gmt, '_expanded_with_', exp_libname, '_transformed.csv')
    print(output_fname)
    expand_gmt(gmt_fname=paste0('libs\\', gmt, '_transformed.csv'), expansion_fname=paste0('gene_coexp_data\\', expansion, '.csv'), output_fname=output_fname)
  }
}
```